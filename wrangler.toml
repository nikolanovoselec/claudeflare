# Claudeflare - Browser-based Claude Code on Cloudflare
name = "claudeflare"
main = "src/index.ts"
compatibility_date = "2025-01-30"
compatibility_flags = ["nodejs_compat"]

# Enable container logs in Cloudflare dashboard
[observability]
enabled = true

# Environment variables
[vars]
DEV_MODE = "false"
# Allowed CORS origins (comma-separated domain patterns)
ALLOWED_ORIGINS = ".workers.dev,.your-domain.com"
# R2_BUCKET_NAME removed - per-user buckets now

# REMOVE or comment out - per-user buckets are created dynamically
# [[r2_buckets]]
# binding = "STORAGE"
# bucket_name = "claudeflare-storage"

# KV namespace for session metadata
[[kv_namespaces]]
binding = "KV"
id = "359e06b11d094813ace300d96b6a2f5f"

# Container configuration - using custom instance type
# 1 vCPU, 3 GiB memory, 4 GB disk
# Required for node-pty + claude-code CLI + npm operations
[[containers]]
class_name = "container"
image = "./Dockerfile"
max_instances = 50

[containers.instance_type]
vcpu = 1
memory_mib = 3072
disk_mb = 4000

# Durable Objects binding for the container
[[durable_objects.bindings]]
name = "CONTAINER"
class_name = "container"

# Migrations
[[migrations]]
tag = "v1"
new_sqlite_classes = ["ClaudeflareContainer"]

[[migrations]]
tag = "v2"
new_sqlite_classes = ["container"]

# Step 2: Delete old class (all its DOs will be deleted)
[[migrations]]
tag = "v3"
deleted_classes = ["ClaudeflareContainer"]

# Static assets (frontend) with SPA routing
[assets]
directory = "./web-ui/dist"
binding = "ASSETS"
not_found_handling = "single-page-application"
