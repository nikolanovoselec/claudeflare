# Claudeflare - Browser-based Claude Code on Cloudflare
name = "claudeflare"
main = "src/index.ts"
compatibility_date = "2025-01-30"
compatibility_flags = ["nodejs_compat"]

# Enable container logs in Cloudflare dashboard
[observability]
enabled = true

# Environment variables
[vars]
DEV_MODE = "false"
# Allowed CORS origins (comma-separated domain patterns)
# Additional origins are managed dynamically via KV (setup:custom_domain, setup:allowed_origins)
ALLOWED_ORIGINS = ".workers.dev"
# R2 config - used by getR2Config() to construct S3 endpoint for container rclone sync
# Also available as KV fallback (setup:account_id, setup:r2_endpoint) for forks using setup wizard
R2_ACCOUNT_ID = "ab75f75941a21a81db27bf12e99c620b"
R2_ENDPOINT = "https://ab75f75941a21a81db27bf12e99c620b.r2.cloudflarestorage.com"

# REMOVE or comment out - per-user buckets are created dynamically
# [[r2_buckets]]
# binding = "STORAGE"
# bucket_name = "claudeflare-storage"

# KV namespace for session metadata
# The id "placeholder" is for local dev/tests (vitest-pool-workers creates in-memory KV).
# deploy.yml resolves the real namespace ID at deploy time via wrangler kv namespace commands.
[[kv_namespaces]]
binding = "KV"
id = "placeholder"

# Container configuration - using custom instance type
# 1 vCPU, 3 GiB memory, 4 GB disk
# Required for node-pty + claude-code CLI + npm operations
[[containers]]
class_name = "container"
image = "./Dockerfile"
max_instances = 50

[containers.instance_type]
vcpu = 1
memory_mib = 3072
disk_mb = 4000

# Durable Objects binding for the container
[[durable_objects.bindings]]
name = "CONTAINER"
class_name = "container"

# Migrations
[[migrations]]
tag = "v1"
new_sqlite_classes = ["container"]

# Static assets (frontend) with SPA routing
[assets]
directory = "./web-ui/dist"
binding = "ASSETS"
not_found_handling = "single-page-application"
